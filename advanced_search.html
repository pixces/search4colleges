<?php 
	require_once('includes/header.php');
	session_start();
	
	//initialize variables
	$perpage			= '10';
	$page				= optional_param('page', '0', PARAM_TEXT); 
	$start				= ($page) * $perpage;	
	$baseurl			= 'advanced_search.html?page';
	$msg				= optional_param('msg', '', PARAM_TEXT); 
	$qstr               = "";
	$campus_area        = "";
	$only_for_locals    = "";
	$state              = "";
	$city               = "";
	$population         = "";
	$majors             = "";
	$student_body       = "";
	$cultural_diversity = "";
	$going_greek        = "";
	$dorm_sweet_dorm    = "";
	$selectivity        = "";
	$gpa                = "";
	$club               = "";
	$sports             = "";
	$degree             = "";
	$affiliations_accreditation = "";
	$school_type        = "";
	$tution_fees        = "";
	$school_name        = "";
	$extraselect        = "";

    /*
	//filter expired college from feuser
    $currentDate = time();
    $dateData = get_records_sql("SELECT id,added_date FROM fe_users WHERE status='active' and id NOT IN (SELECT school_id FROM school_membership WHERE status='active' and expiryon > ".time().")");

    $exp_date = array();
    foreach($dateData as $dateDataval)
    {
        $login30Day = strtotime('+30days', $dateDataval->added_date);
        if($currentDate > $login30Day){
        $exp_date[$dateDataval->id] = $dateDataval->id;
        }
    }
    */

	//posted form data and create advance search query

	if(isset($_REQUEST['submit'])){	
		$campus_area 				= optional_param('campus_area','',PARAM_RAW);
		$only_for_locals 			= optional_param('only_for_locals','',PARAM_RAW);
		$state 						= optional_param('state','', PARAM_RAW);
		$city 						= optional_param('city','', PARAM_RAW);
		$school_name 				= optional_param('school_name','', PARAM_RAW);
		$population 				= optional_param('population','', PARAM_RAW);
		$majors 					= optional_param('majors','', PARAM_RAW);		
		$student_body 				= optional_param('student_body','', PARAM_RAW);
		$cultural_diversity 		= optional_param('cultural_diversity','', PARAM_RAW);
		$going_greek 				= optional_param('going_greek','', PARAM_RAW);
		$dorm_sweet_dorm 			= optional_param('dorm_sweet_dorm','', PARAM_RAW);
		$selectivity 				= optional_param('selectivity','', PARAM_RAW);
		$gpa 						= optional_param('gpa','', PARAM_RAW);
		$club 						= optional_param('club','', PARAM_RAW);
		$degree 					= optional_param('degree','', PARAM_RAW);
		$affiliations_accreditation = optional_param('affiliations_accreditation','', PARAM_RAW);
		$school_type 				= optional_param('school_type','', PARAM_RAW);
		$tution_fees 				= optional_param('tution_fees','', PARAM_RAW);
		$sports 					= optional_param('sports','', PARAM_RAW);

        $search         			= optional_param('search',true, PARAM_RAW);


        //create query
        #search logic
        #get all schools, do a union, remove duplicates
        #then display them in order of featured first and expired last



        # Get all the subscribed schools details
        $subscribedSchoolsSql = "SELECT school_id FROM {$CFG->prefix}school_membership WHERE status='active' AND expiryon > ".time();
        $subscribedSchools = get_records_sql($subscribedSchoolsSql);
        $subscribedSchoolIDs = array();
        $filterQuery = "";
        // matching only schools those are subscribed
        if($subscribedSchools) {
            $subscribedSchoolIDs = array_keys($subscribedSchools);
            $fromSubscribedSchools = " AND school_id IN (".implode(",",$subscribedSchoolIDs).")";
        }

        $listedIds = array();
        $additionalIds = array();
        $school_result = array();
        $otherListResult = array();

        $primaryResultCount = $otherListCount = 0;

        // Primary search
            # all the where clause parameter for schools_additional data will be added to this array
            $additionalClause = array();
            #all the queries for UNION goes here
            $UNION = array();
            #final query clause
            $finalClause = array();

            if($search || $start == 0) {
                $search = true;
                unset($_SESSION['listed_ids']);
                unset($_SESSION['primary_result_count']);
                unset($_SESSION['custom_start']);
            }


            if($only_for_locals!=''){
                $additionalClause[] = "only_for_local = '".$only_for_locals."'";
                $qstr .= "&only_for_locals=".$only_for_locals;
            }

            $stateQuery = "";
            if($state!=''){
                $finalClause[] = "state = ".$state;
                $qstr .= "&state=".$state;
            }

            $cityQuery = "";
            if($city!=''){
                $finalClause[] = "city = ".$city;
                $qstr .= "&city=".$city;
            }

            if($population!=''){
                $between = explode("_",$population);
                $betweenQuery = count($between)==2 ? " BETWEEN ".$between[0]." AND ".$between[1] : ">=".$between[0];
                $additionalClause[] = "student_population ".$betweenQuery;
                $qstr .= "&population=".$population;
            }

            if(isset($majors) && !empty($majors)){
                if(is_array($majors))
                {
                    $majorsSql = implode(",",$majors);
                    $UNION[] = "SELECT school_id FROM {$CFG->prefix}school_major WHERE major_id IN (".$majorsSql.")";
                    $majorsData = implode("-",$majors);
                }
                $qstr .= "&majors=".$majorsData;
            }

            if($student_body!=''){
                $additionalClause[] = "student_body = ".$student_body;
                $qstr .= "&student_body=".$student_body;
            }

            if($cultural_diversity!=''){
                $additionalClause[] = "cultural_diversity = ".$cultural_diversity;
                $qstr .= "&cultural_diversity=".$cultural_diversity;
            }

            $goingGreekQuery = "";
            if($going_greek!=''){
                $goingGreekQuery = " AND going_greek = '".$going_greek."'";
                $qstr .= "&going_greek=".$going_greek;
            }

            $dormQuery = "";
            if($dorm_sweet_dorm!=''){
                $dormQuery = " AND dorm_sweet_dorm = '".$dorm_sweet_dorm."'";
                $qstr .= "&dorm_sweet_dorm=".$dorm_sweet_dorm;
            }

            $selectivityQuery = "";
            if($selectivity!=''){
                $selectivityQuery = " AND selectivity = '".$selectivity."'";
                $qstr .= "&selectivity=".$selectivity;
            }

            $gpaQuery = "";
            if($gpa!=''){
                $gpaQuery = " AND schoolculture_campuslife_gpa_id = ".$gpa;
                $qstr .= "&gpa=".$gpa;
            }

            #filter school_culture_campus_life
            if($goingGreekQuery!="" || $dormQuery!="" || $selectivityQuery!="" || $gpaQuery!=""){
                $UNION[] = "SELECT school_id FROM {$CFG->prefix}school_culture_campus_life WHERE 1=1 ". $goingGreekQuery . $dormQuery . $selectivityQuery . $gpaQuery;
            }

            if($club!=''){
                $UNION[] = "SELECT school_id FROM {$CFG->prefix}school_club_mm WHERE club_id = ". $club;
                $qstr .= "&club=".$club;
            }

            if($degree!=''){
                $UNION[] = "SELECT school_id FROM {$CFG->prefix}school_admission_details WHERE degree_id = $degree";
                $qstr .= "&degree=".$degree;
            }

            if($affiliations_accreditation!=''){
                $additionalClause[] = "affiliations_id != 0";
                $qstr .= "&affiliations_accreditation=".$affiliations_accreditation;
                $affiliationChecked = 'checked="checked"';
            } else {
                $affiliationChecked = '';
            }


            if($school_type!=''){
                $additionalClause[] = "institution_type = '".$school_type."'";
                $qstr .= "&school_type=".$school_type;
            }

            #does this exists in the query ?
            if($tution_fees!=''){
                $qstr .= "&tution_fees=".$tution_fees;
            }

            if($sports!=''){
                $UNION[] = "SELECT school_id FROM {$CFG->prefix}school_culture_campus_life_sports WHERE team_type = '". $sports . "'";
                $qstr .= "&sports=".$sports;
            }

            if($school_name!=''){
                $finalClause[] = "school_name like '%".$school_name."%'";
                $qstr .= "&school_name=".$school_name;
            }

            $qstr .= "&submit=y";


            #campus area
            if(isset($campus_area) && !empty($campus_area)){
                if(is_array($campus_area)){
                    $additionalClause[] = "type_of_campus_area IN (".implode(",",$campus_area).")";
                    $campusArea = implode("-",$campus_area);
                }
                $qstr .= "&campus_area=".$campusArea;
            }

            if(!empty($additionalClause)){
                $additionalWhereClause = !empty($additionalClause) ? " AND ". implode(" AND ",$additionalClause) : "";
                $UNION[] = "SELECT school_id FROM {$CFG->prefix}schools_additional WHERE 1=1 ". $additionalWhereClause;
            }


            #this creates the hrefurl for the pagination
            if($qstr){
                $qstr=substr($qstr,1);
                $baseurl = "advanced_search.html?".$qstr;
            }


            #search for academics
            if(!empty($UNION)){
                $UNION_QUERY = implode(" UNION ",$UNION);
                $union_result = get_records_sql($UNION_QUERY);
                #echo "<pre>"; print_r($UNION_QUERY);
            }

            $finalFilterList = array();
            if($union_result && !empty($union_result)) {
                $finalFilterList = array_keys($union_result);
            }


            if(!empty($finalFilterList)){
                $finalClause[] = "id IN (".implode(",",$finalFilterList).")";
            }

            #final query from schools table
            $ORDER = " ORDER BY CASE WHEN id IN (".implode(',',$subscribedSchoolIDs).") THEN -1 ELSE id END,featured,school_name";
            $LIMIT = " LIMIT ".$start.",".$perpage;

            #$ORDER = " ORDER BY FIELD(id,'".implode(',',$subscribedSchoolIDs)."'),featured,school_name";
            #$ORDER = " ORDER BY featured,school_name";
            #$LIMIT = " LIMIT ".$start.", 100";

            $finalQuery = "SELECT * FROM {$CFG->prefix}schools WHERE  1=1";
            $primaryResultCountQuery = "SELECT count(id) FROM {$CFG->prefix}schools WHERE  1=1";

            if(!empty($finalClause)){
                $finalQuery .= " AND " . implode(" AND ",$finalClause);
                $primaryResultCountQuery .= " AND " . implode(" AND ",$finalClause);
            }

            // Find the total result count of the primary result
            $primaryResultCount = count_records_sql($primaryResultCountQuery);

            $finalQuery .= $ORDER.$LIMIT;
            #update schools set `featured` = 'no' where `featured` = ""; // to update the empty columns

            $school_result = get_records_sql($finalQuery);
            #echo "$primaryResultCountQuery|".$_SESSION['primary_result_count']."|$primaryResultCount";
            #echo "$finalQuery|<pre>"; print_r($school_result);

            /**
             * If the school result is not empty, prepare a list of school ids,
             *      those are displayed and make one more set of result for "Schools you might be interested" list,
             *      exclude those are already displayed.
             *      Calculate the pages, based on the searched query
             * NOTE: 10 result per page, if the searched result has only 3, and has paid list, then 3 (serached) + 7 (paid)
             * If result is empty, get a list of schools those are paid membership
             */
            if($school_result && !empty($school_result)){
                $listedIds = array_keys($school_result);
                $additionalIds = $listedIds;
            }

            if($search){
                $_SESSION['primary_result_count'] = $primaryResultCount;
                $_SESSION['listed_ids'] = $listedIds;
            }
            #print_r($_SESSION['listed_ids']$_SESSION['primary_result_count']);

         // Primary search ends here

        // Store the primary result count in session
        // If no search query matches, fetch all the paid members
        if($_SESSION['primary_result_count']==0){
            $search = false;
            $otherListQuery = "SELECT * FROM {$CFG->prefix}schools WHERE 1=1 ";

            $ORDER = " ORDER BY CASE WHEN id IN (".implode(',',$subscribedSchoolIDs).") THEN -1 ELSE id END,featured,school_name";
            $LIMIT = " LIMIT ".$start.",".$perpage;


            // Find the other list result count
            $otherListCountQuery = "SELECT count(id) FROM {$CFG->prefix}schools";
            $otherListCount = count_records_sql($otherListCountQuery);

            $otherListQuery .= $ORDER.$LIMIT;

            $otherListResult = get_records_sql($otherListQuery);
            if($otherListResult){
                $additionalIds = array_keys($otherListResult);
            }
        } else {
            if($perpage > $_SESSION['primary_result_count']) {
                // More pending works are there, need a thorough testing for paginating up and down

                $otherListLimit = ($search==true)? ($perpage - $_SESSION['primary_result_count']) : $perpage;
                $customStarter =  $start  - $_SESSION['primary_result_count'];
                $customStart =  $customStarter > 0 ? $customStarter : 0;
                #$customStart =  isset($_SESSION['custom_start']) && $_SESSION['custom_start'] > 0 ? $_SESSION['custom_start'] : 0;
                #$_SESSION['custom_start'] += $perpage;
                #$customStart =  $start  - $_SESSION['primary_result_count'];

                $LIMIT = " LIMIT ".$customStart.",".$otherListLimit;
                if($otherListLimit>0){
                    $search = false;
                    #print_r($_SESSION['listed_ids']);
                    $otherListQuery = "SELECT * FROM {$CFG->prefix}schools WHERE id NOT IN (".implode(",",$_SESSION['listed_ids']).")";
                    $ORDER = " ORDER BY CASE WHEN id IN (".implode(',',$subscribedSchoolIDs).") THEN -1 ELSE id END,featured,school_name";

                    // Find the other list result count
                    $otherListCountQuery = "SELECT count(id) FROM {$CFG->prefix}schools WHERE id NOT IN (".implode(",",$_SESSION['listed_ids']).")";
                    $otherListCount = count_records_sql($otherListCountQuery);

                    $otherListQuery .= $ORDER.$LIMIT;
                    $otherListResult = get_records_sql($otherListQuery);
                    if($otherListResult){
                        $otherListedIds = array_keys($otherListResult);
                        array_push($additionalIds, $otherListedIds);
                        array_push($listedIds,$otherListedIds);
                    }


                }
            }
        }

        
        $totalcount =  $_SESSION['primary_result_count']+$otherListCount;

        // Fetch school_additional info
        $schoolAdditionalFields = "school_id,institution_type";
        $schoolAdditionalQuery = "SELECT $schoolAdditionalFields FROM {$CFG->prefix}schools_additional WHERE school_id IN (".implode(",",$additionalIds).")";
        $schoolAdditionalInfo = get_records_sql($schoolAdditionalQuery);
        $baseurl .= "&search=".$search;

        #echo "<pre>".$_SESSION['primary_result_count']."|".$otherListCount;

	}
?>

  
  <!-- content section >> -->
  <div id="content_sec">
  <script language="JavaScript">
	function show_search(){

		var title_id = document.getElementById("title_id").style.display;

		if (title_id == 'block') {
		    document.getElementById("title_id").style.display = 'none';
		} else {
		    document.getElementById("title_id").style.display = 'block';
		}

		var accr_id = document.getElementById("accr_id").style.display;
		if (accr_id == 'block') {
		    document.getElementById("accr_id").style.display = 'none';
		} else {
		    document.getElementById("accr_id").style.display = 'block';
		}

		var search_id = document.getElementById("search_id").style.display;
		if (search_id == 'block') {
		    document.getElementById("search_id").style.display = 'none';
		} else {
		    document.getElementById("search_id").style.display = 'block';
		}

		var filter_id = document.getElementById("filter_id").style.display;
		if (filter_id == 'block') {
		    document.getElementById("filter_id").style.display = 'none';
		} else {
		    document.getElementById("filter_id").style.display = 'block';
		}
	}

  
    <!--
	function isNumberKey(evt){
		var charCode = (evt.which) ? evt.which : event.keyCode
		if ((charCode > 31 || charCode == 8) && (charCode < 48 || charCode > 57)){
			return true;
		} else {
			return false;
		}
	}
    //-->
	function view_count(id)
	{
			var req = new Request({
			 method: 'post',
			 url: 'ajax_handler.php',
			 data: {'id':id,
					'flag' : 'view_count'						
				 },
			 onRequest: function() {},
			 onComplete: function(response) {
			 }
		}).send();
	}

	/**
	* Function to get the list of cities
	* added by Sadik on Sun May 5 2013
	*/
	function get_cities(id){
	  var req = new Request({
	      method: 'get',
	      url: 'ajax_handler.php',
	      data: {'id':id,
	          'flag' : 'city_from'
	      },
	      onRequest: function() {},
	      onComplete: function(response) {
	          $('city').innerHTML = response;
	      }
	  }).send();
	}


	window.addEvent('domready', function(){
	  $('state').addEvent('change',function() {
	      var state_id = this.get("value");
	      get_cities(state_id);
	  });
	});
	//  $("state").on('change',function(){
	//      var id = $(this).attr('id');
	//      console.info(id);
	//      get_cities(id);
	//  });

  </script>
    <!-- << left content -->
  <?php require_once("includes/left_content.php"); ?>
  <!-- left content >> -->
	
	<!-- << inner content -->
    <div id="inner_content">
      <div class="inner_top">
        <div class="inner_link">
          <ul>
            <li><a href="index.html"><strong>Home</strong></a></li>
            <li class="in_aroow"><span>Search Colleges</span></li>
          </ul>
        </div>
        <?php if(isset($_SESSION['user_login']) && $_SESSION['user_login'] =='yes'){ 
				if(($expired == 0)){ 
		?>
			<div class="in_Right_link"><a href="#"></a><a href="my_account.html">My Account</a></div>
		<?php }} ?>

        <div class="clear"></div>
        <h1><span>Colleges</span></h1>
        <div class="clear"></div>
      </div>
	  
	  
      <div class="clear"></div>
		<form method="post" action="advanced_search.html" id="advanceSearch" name="advance_search">
		<div id="upload_form">
        <div class="rgs_heading"> 
		<br />
        <div <?php if(!empty($student_data2)) {?> style="display:none;" <?php } ?> id="title_id"><h2>Search Colleges by following criteria's</h2></div>		
		
		<?php if(isset($_REQUEST['submit'])) { ?>
			<h2 align='center'><?php if($_SESSION['primary_result_count']==0){ echo "No Records Found !!"; }else{ echo $_SESSION['primary_result_count']." Record(s) Found !!"; } ?></h2>
		<?php } elseif(isset($_GET['msg'])) { ?>
			<h2 align='center'><?php echo $msg; ?></h2>
		<?php } ?>

		<!--<span style="cursor:pointer" onclick="window.location='advanced_search.html'">Reset</span>-->

		<dl class="accordion" <?php if(!empty($student_data2)) {?> style="display:none;" <?php } ?> id="accr_id">

		<dt class="accordion_toggler_1">BASIC</dt>
			<dd class="accordion_content_1">

                <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding-left: 20px;">
				<br><b>KEYWORD:</b>

				<input name="school_name" size="18" type="text" class="small_input1  input-text" value="<?php echo $school_name; ?>" onkeypress="return isNumberKey(event)"/>
			<br>
				<br><b>TYPE OF CAMPUS AREA</b><br>
				Beyond geography, where do you want to be? Take your pick<br />
				<?php

		        $sql 				= ("SELECT * FROM {$CFG->prefix}campus_type WHERE status = 'active'");
				$campus_data		= get_records_sql($sql);

				foreach($campus_data as $campus)
					{
						if(is_array($campus_area)&&in_array($campus->id,$campus_area))
						{
							if(!empty($campus->type))
							{
				?>
								<input type="checkbox" checked="checked" name="campus_area[]" value="<?php echo $campus->id; ?>" /><?php echo $campus->type; ?><br>

				<?php
							}
						}
						else
						{
				?>			<input type="checkbox" name="campus_area[]" value="<?php echo $campus->id; ?>" /><?php echo $campus->type; ?><br>
				<?php	}
					}
				?>
				<br><b>STATE</b><br>
				<select name="state" id="state">
				<option value="">Select</option>
				<?php
					$state_data = get_records('state','status','active');
					if($state_data)
					{
						foreach($state_data as $svalue)
						{
							if($svalue->id==$state)
							{
				?>				<option selected="selected" value="<?php echo $svalue->id; ?>"><?php echo $svalue->name; ?></option>
				<?php 		}
							else
							{
				?>				<option value="<?php echo $svalue->id; ?>"><?php echo $svalue->name; ?></option>
				<?php		}
						}
					}
				?>
				</select>
				<br><br><b>CITY</b><br>
				<select name="city" id="city">
				<option value="">Select</option><?php
				     $sql 				= ("SELECT * FROM {$CFG->prefix}city WHERE status = 'active' AND state_id = $state");
                     $city_data		    = get_records_sql($sql);
					if($city_data)
					{
						foreach($city_data as $cvalue)
						{
							if($cvalue->id==$city)
                    {
                    ?>				<option selected="selected" value="<?php echo $cvalue->id; ?>"><?php echo $cvalue->name; ?></option>
                    <?php 		}
							else
							{
				?>				<option value="<?php echo $cvalue->id; ?>"><?php echo $cvalue->name; ?></option>
                    <?php		}
						}
					}
				?>
				</select>
				<br>
				<br><b>STUDENT POPULATION</b><br>
				<select name="population" class="only_for_locals">
				<option value="">Select</option>
				<?php
					//student population listing
					$student_population = get_records('school_student_population','status','active');
					if($student_population)
					{
						echo "<br><b>STUDENT POPULATION</b><br>";
						echo "How many people do you want to school with?<br />";

                        $std_data = array();
                        $std_data['1_1000']='1000';
                        $std_data['1000_2000']='2000';
                        $std_data['2000_3000']='3000';
                        $std_data['3000_5000']='5000';
                        $std_data['5000_10000']='10000';
                        $std_data['10000_15000']='15000';
                        $std_data['15000']='15000 +';


						foreach($std_data as $key=>$data)
						{
							if($key==$population)
							{
				?>				<option selected="selected" value="<?php echo $key; ?>"><?php echo $data; ?></option>
				<?php		}
							else
							{
				?>				<option value="<?php echo $key; ?>"><?php echo $data; ?></option>
				<?php		}
						}
					}
				?>
				</select>
				<br>
				<br><b>COLLEGE TYPE</b><br>
				<select name="school_type" class="only_for_locals">
				<option value="">Select</option>
				<?php
					$sql = "SELECT * FROM {$CFG->prefix}school_type WHERE status = 'active'";
					$school_type_data = get_records_sql($sql);
					if($school_type_data)
					{
						foreach($school_type_data as $type_data)
						{
							if(!empty($type_data->type))
							{
								if($type_data->type==$school_type)
								{
				?>					<option selected="selected" value="<?php echo $type_data->type; ?>">
									<?php echo $type_data->type; ?></option>
				<?php 			}
								else
								{
				?>				<option value="<?php echo $type_data->type; ?>">
								<?php echo $type_data->type; ?></option>
				<?php			}
							}
						}
					}
				?>
				</select>
				<br><br>
				<b>AFFILIATIONS/ ACCREDITATION</b><br>
                <input type="checkbox" name="affiliations_accreditation" <?php echo $affiliationChecked; ?>/>Accredited Schools only<br>
                </div>
			</dd>
			<dt class="accordion_toggler_2">ACADEMICS</dt>
			<dd class="accordion_content_2">
				<div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding-left: 20px;">
                <?php
					//degrees offered listing
					$degrees_offered = get_records('school_degrees_offered','status','active');
					if($degrees_offered)
					{
						echo "<br><b>DEGREES OFFERED</b><br>";
						foreach($degrees_offered as $doffer)
						{
							if($doffer->id==$degree)
							{
				?>				<input type="radio" checked="checked" name="degree" value="<?php echo $doffer->id; ?>" /><?php echo $doffer->degree; ?><br>
				<?php		}
							else
							{
				?>				<input type="radio" name="degree" value="<?php echo $doffer->id; ?>" /><?php echo $doffer->degree; ?><br>
				<?php		}
						}
					}
				?>
					<br><b>MAJORS</b><br>
					<select multiple name="majors[]" size="10" style="padding:10px; border:1px solid #DCDCDC; background-color:#f4f4f4; margin-top:5px; margin-bottom:5px;">
					<?php
						//$main_majors = get_records('majors','parent_id','0');
						$qry = "SELECT * FROM {$CFG->prefix}majors WHERE parent_id='0' AND status='active'";
						$main_majors = get_records_sql($qry);
						if($main_majors)
						{
							foreach($main_majors as $main)
							{
					?>			<option disabled value="0" style="font-size: 11px;"><?php echo $main->name; ?></option>
								<?php
									//$major_data = get_records('majors','parent_id',$main->id);
									$qry = "SELECT * FROM {$CFG->prefix}majors WHERE parent_id=".$main->id." AND status='active'";
									$major_data = get_records_sql($qry);
									if($major_data)
									{
										foreach($major_data as $data)
										{
											if(is_array($majors)&&in_array($data->id,$majors))
											{
								?>				<option selected="selected" value="<?php echo $data->id; ?>">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php echo $data->name; ?></option>
								<?php		}
											else
											{
								?>				<option style="font-size: 11px; margin:4px;" value="<?php echo $data->id; ?>">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php echo $data->name; ?></option>
								<?php		}
										}
									}
							}
						}
					?>
				</select><br><br>
                </div>
			</dd>
			<dt class="accordion_toggler_3">STUDENT BODY</dt>
			<dd class="accordion_content_3">
            <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding-left: 20px;">
				<?php
					//school student body listing
					$school_student_body = get_records('school_student_body','status','active');
					if($school_student_body)
					{
						echo "<br><b>MALE/ FEMALE RATIO</b><br>";
						foreach($school_student_body as $s_body)
						{
							if($s_body->id==$student_body)
							{
				?>				<input checked="checked" type="radio" name="student_body" value="<?php echo $s_body->id; ?>" /><?php echo $s_body->title; ?><br>
				<?php		}
							else
							{
				?>				<input type="radio" name="student_body" value="<?php echo $s_body->id; ?>" /><?php echo $s_body->title; ?><br>
				<?php		}
						}
					}

					//cultural diversity listing
					$c_diversity = get_records('school_cultural_diversity','status','active');
					if($c_diversity)
					{
						echo "<br><b>CULTURAL DIVERSITY</b><br>";
						foreach($c_diversity as $culture)
						{
							if($culture->id==$cultural_diversity)
							{
				?>				<input type="radio" checked="checked" name="cultural_diversity" value="<?php echo $culture->id; ?>" /><?php echo $culture->title; ?><br>
				<?php		}
							else
							{
				?>				<input type="radio" name="cultural_diversity" value="<?php echo $culture->id; ?>" /><?php echo $culture->title; ?><br>
				<?php		}
						}
					}
				?>

				<br><b>ONLY FOR LOCALS</b><br>
				<?php
					$local_data = array();
					$local_data[0]='Mostly in-state';
					$local_data[1]='Mostly out-of-state';
					$local_data[2]='Balanced';
					$local_data[3]='Any';

					foreach($local_data as $ldata)
					{
						if($ldata==$only_for_locals)
						{
				?>			<input type="radio" checked="checked" name="only_for_locals" value="<?php echo $ldata; ?>" /><?php echo $ldata; ?><br>
				<?php	}
						else
						{
				?>			<input type="radio" name="only_for_locals" value="<?php echo $ldata; ?>" /><?php echo $ldata; ?><br>
				<?php	}
					}
				?><br>
				</div>
			</dd>


			<dt class="accordion_toggler_4">CAMPUS LIFE</dt>
			<dd class="accordion_content_4">
            <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding-left: 20px;">
				<br><b>SPORTS</b><br>
				<?php if($sports=='men') { ?>
					<input checked="checked" type="radio" name="sports" value="men" />Men<br>
				<?php } else { ?>
					<input type="radio" name="sports" value="men" />Men<br>
				<?php } if($sports=='women') { ?>
					<input checked="checked" type="radio" name="sports" value="women" />Women<br>
				<?php } else { ?>
					<input type="radio" name="sports" value="women" />Women<br>
				<?php }

					//campus life clubs listing
					$campus_life_clubs = get_records('school_culture_campuslife_clubs','status','active');
					if($campus_life_clubs)
					{
						echo "<br><b>CLUBS</b><br>";
						foreach($campus_life_clubs as $life_club)
						{
							if($life_club->id==$club)
							{
				?>				<input type="radio" checked="checked" name="club" value="<?php echo $life_club->id; ?>" /><?php echo $life_club->club_title; ?><br>
				<?php		}
							else
							{
				?>				<input type="radio" name="club" value="<?php echo $life_club->id; ?>" /><?php echo $life_club->club_title; ?><br>
				<?php		}
						}
					}
				?><br>
                </div>
			</dd>


			<dt class="accordion_toggler_5">GOING GREEK</dt>
			<dd class="accordion_content_5">
            <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding:10px 0px 10px 20px;">
			<?php
				$going_data = array();
				$going_data[0]='Sororities';
				$going_data[1]='Fraternities';
				$going_data[2]='Any';

				foreach($going_data as $going)
				{
					if($going==$going_greek)
					{
			?>			<input type="radio" checked="checked" name="going_greek" value="<?php echo $going; ?>" /><b><?php echo $going; ?></b><br>
			<?php	}
					else
					{
			?>			<input type="radio" name="going_greek" value="<?php echo $going; ?>" /><b><?php echo $going; ?></b><br>
			<?php	}
				}
			?>
            </div>
			</dd>

			<dt class="accordion_toggler_6">DORM, SWEET DORM?</dt>
			<dd class="accordion_content_6">
            <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding:10px 0px 10px 20px;">
			<?php
				$dorm_data = array();
				$dorm_data[0]='Yes-at least for freshmen';
				$dorm_data[1]='Yes-for all undergrads';

				foreach($dorm_data as $dorm)
				{
					if($dorm==$dorm_sweet_dorm)
					{
			?>			<input type="radio" checked="checked" name="dorm_sweet_dorm" value="<?php echo $dorm; ?>" /><b><?php echo $dorm; ?></b><br>
			<?php	}
					else
					{
			?>			<input type="radio" name="dorm_sweet_dorm" value="<?php echo $dorm; ?>" /><b><?php echo $dorm; ?></b><br>
			<?php	}
				}
			?>
            </div>
			</dd>

			<dt class="accordion_toggler_7">GETTING IN</dt>
			<dd class="accordion_content_7">
            <div style="border:1px solid #DCDCDC; background-color:#f4f4f4; margin:0px; padding-left: 20px;">
				<br><b>SELECTIVITY</b><br>
				<?php
					$select_data = array();
					$select_data[0]='Very difficult';
					$select_data[1]='Moderately difficult';
					$select_data[2]='Minimally difficult';

					foreach($select_data as $select)
					{
						if($select==$selectivity)
						{
				?>			<input type="radio" checked="checked" name="selectivity" value="<?php echo $select; ?>" /><?php echo $select; ?><br>
				<?php	}
						else
						{
				?>			<input type="radio" name="selectivity" value="<?php echo $select; ?>" /><?php echo $select; ?><br>
				<?php	}
					}

					//GPA listing
					$campus_life_gpa = get_records('school_culture_campuslife_gpa','status','active');
					if($campus_life_gpa)
					{
						echo "<br><b>GPA</b><br>";
						foreach($campus_life_gpa as $life_gpa)
						{
							if($life_gpa->id==$gpa)
							{
				?>				<input type="radio" checked="checked" name="gpa" value="<?php echo $life_gpa->id; ?>" /><?php echo $life_gpa->gpa; ?><br>
				<?php		}
							else
							{
				?>				<input type="radio" name="gpa" value="<?php echo $life_gpa->id; ?>" /><?php echo $life_gpa->gpa; ?><br>
				<?php		}
						}
					}
				?><br>
              </div>
			</dd>

		</dl>

        <div class="clear"> </div>
		</div>
		<div class="wraper6">
			<input type="hidden" name="submit" value="submit" />
			<div <?php if(!empty($student_data2)) {?> style="display:none;width:100px;float:left;" <?php }else{?> style="width:100px;float:left;"<?php } ?> id="search_id">
			<input type="image" src="images/search_btn.jpg" style="width:84px; height:23px;" />
			</div>
			&nbsp;&nbsp;&nbsp;&nbsp;<span <?php if(!empty($student_data2)) {?> style="cursor:pointer;display:block;float:left;" <?php }else{?>style="cursor:pointer;display:none;float:left;" <?php } ?> onclick="show_search();" id="filter_id"><img src="images/refine-search.png" alt="" /></span>&nbsp;&nbsp;&nbsp;&nbsp;
			&nbsp;&nbsp;&nbsp;&nbsp;<span style="cursor:pointer;float:left;" onclick="window.location='advanced_search.html'"><img src="images/clear-search.png" alt="" /></span>&nbsp;&nbsp;&nbsp;&nbsp;
			&nbsp;&nbsp;&nbsp;&nbsp;
			&nbsp;&nbsp;&nbsp;&nbsp;<span style="cursor:pointer;float:left;" onclick="window.location='colleges.html'"><img src="images/basic-search.png" alt="" /></span>&nbsp;&nbsp;&nbsp;&nbsp;

			<?php if(isset($_SESSION['s4c_user_id'])&&isset($_REQUEST['submit'])&&$totalcount!=0) { ?><a rel="lightbox['search' 45% 85%]" href="save_advanced_search.html?campus_area=<?php echo $c_area; ?>&state=<?php echo $state; ?>&population=<?php echo $population; ?>&school_type=<?php echo $school_type; ?>&affiliations_accreditation=<?php echo $affiliations_accreditation; ?>&degree=<?php echo $degree; ?>&mfratio=<?php echo $student_body; ?>&cultural_diversity=<?php echo $cultural_diversity; ?>&locals=<?php echo urlencode($only_for_locals); ?>&sports=<?php echo $sports; ?>&club=<?php echo $club; ?>&going_greek=<?php echo $going_greek; ?>&dorm_sweet_dorm=<?php echo urlencode($dorm_sweet_dorm); ?>&selectivity=<?php echo $selectivity; ?>&gpa=<?php echo $gpa; ?>&majors=<?php echo $major_ids; ?>&school_name=<?php echo $school_name?>&query=<?php echo $query; ?>">Save Search</a><?php } ?>

        </div>
		</div>
		</form>
		<div id="upload_form_btm"></div>

	<?php
		if(!empty($school_result)){
	?>
	<!-- pagination block start -->
		<?php echo print_paging($totalcount, $page, $perpage, $baseurl,'&page','','','','','');  ?>
	<!-- pagination block end -->

	<table width="100%" border="1" class="table_font">
			<tr bgcolor="#E9E9E9" style="color:#000">
				<!--<td width="10%">Select </td>-->
				<td width="38%">Name </td>
				<td width="11%">Location </td>
				<td width="10%">Type </td>
			  <td width="12%"></td>
			</tr>
			<?php
				foreach($school_result as $data)
				{
					/*
					$student_data_selectivirty = get_record_sql('SELECT * FROM '.$CFG->prefix.'school_culture_campus_life WHERE status = "active" AND school_id='.$data->user_id);
					$selectivity = '';

					if(!empty($student_data_selectivirty))
					{
						$selectivity = $student_data_selectivirty->selectivity;
					}
                    */

					$city	= cmi_genrate_url(get_data_frontend('city','name',$data->city));
					$state	= cmi_genrate_url(get_data_frontend('state','name',$data->state));
					if($data->seo_keyword){
						if(isset($_SESSION['s4c_user_id'])){
							if($_SESSION['s4c_user_id'] == $data->user_id)
								$url	= "colleges_profile.html?view=".$data->user_id;
							else
								$url	= $state."/".$city."/".$data->seo_keyword."/profile";
						}
						else
							$url	= $state."/".$city."/".$data->seo_keyword."/profile";
					}
					else
						$url	= "colleges_profile.html?view=".$data->user_id;
			?>
					<tr>
						<!--<td><input type="checkbox" name="checkbox" value="checkbox" /></td>-->
						<td>
							<a href="<?php if(isset($url)) echo $url; ?>" onclick="view_count(<?php echo $data->id; ?>);">
							<?php echo $data->school_name; ?>
							</a>
						</td>
						<td>
							<?php $city = str_replace(array("_","/"),array(" ","-"), $city); if(!empty($city)){ echo ucwords($city).','; }?><br />
							<?php $state = str_replace(array("_","/"),array(" ","-"), $state); if(!empty($state)){ echo ucwords($state); }?>
						</td>
                        <td>
                            <?php echo $schoolAdditionalInfo[$data->id]->institution_type ? $schoolAdditionalInfo[$data->id]->institution_type : ""; ?>
                        </td>
                        <td>
                            Request More
                        </td>
						<!--td><?php $population = get_field('schools_additional','student_population','school_id',$data->user_id); if(!empty($population)){ echo $population; }else{ echo '-';}?> </td>
						<td><?php if(!empty($selectivity)){ $entra = str_replace(array("_","/"),array(" ","-"), $selectivity); echo ucwords($entra);}else{ echo '-';}?></td-->
					</tr>
			<?php
				}

	    if(empty($otherListResult)) {
	    ?>
            </table>
            <?php echo print_paging($totalcount, $page, $perpage, $baseurl,'&page','','','','','');
         }
         ?>
	<?php
		}
		if(empty($school_result) && !empty($otherListResult)) {
		    echo print_paging($totalcount, $page, $perpage, $baseurl,'&page','','','','','');  ?>
        <!-- pagination block end -->

        <table width="100%" border="1" class="table_font">
            <tr bgcolor="#E9E9E9" style="color:#000">
                <!--<td width="10%">Select </td>-->
                <td width="38%">Name </td>
                <td width="11%">Location </td>
                <td width="10%">Type </td>
                <td width="12%"></td>
            </tr>

		<?php } ?>
		<?php

	    if(!empty($otherListResult)){
	    ?>

        <tr>
            <td colspan="4"><h2> Other colleges you might be interested in:</h2></td>
        </tr>
        <?php
				foreach($otherListResult as $data)
				{
					/*
					$student_data_selectivirty = get_record_sql('SELECT * FROM '.$CFG->prefix.'school_culture_campus_life WHERE status = "active" AND school_id='.$data->user_id);
        $selectivity = '';

        if(!empty($student_data_selectivirty))
        {
        $selectivity = $student_data_selectivirty->selectivity;
        }
        */

        $city	= cmi_genrate_url(get_data_frontend('city','name',$data->city));
        $state	= cmi_genrate_url(get_data_frontend('state','name',$data->state));
        if($data->seo_keyword){
        if(isset($_SESSION['s4c_user_id'])){
        if($_SESSION['s4c_user_id'] == $data->user_id)
        $url	= "colleges_profile.html?view=".$data->user_id;
        else
        $url	= $state."/".$city."/".$data->seo_keyword."/profile";
        }
        else
        $url	= $state."/".$city."/".$data->seo_keyword."/profile";
        }
        else
        $url	= "colleges_profile.html?view=".$data->user_id;
        ?>
        <tr>
            <!--<td><input type="checkbox" name="checkbox" value="checkbox" /></td>-->
            <td>
                <a href="<?php if(isset($url)) echo $url; ?>" onclick="view_count(<?php echo $data->id; ?>);">
                    <?php echo $data->school_name; ?>
                </a>
            </td>
            <td>
                <?php $city = str_replace(array("_","/"),array(" ","-"), $city); if(!empty($city)){ echo ucwords($city).','; }?><br />
                <?php $state = str_replace(array("_","/"),array(" ","-"), $state); if(!empty($state)){ echo ucwords($state); }?>
            </td>
            <td>
                <?php echo $schoolAdditionalInfo[$data->id]->institution_type ? $schoolAdditionalInfo[$data->id]->institution_type : ""; ?>
            </td>
            <td>
                Request More
            </td>
            <!--td><?php $population = get_field('schools_additional','student_population','school_id',$data->user_id); if(!empty($population)){ echo $population; }else{ echo '-';}?> </td>
            <td><?php if(!empty($selectivity)){ $entra = str_replace(array("_","/"),array(" ","-"), $selectivity); echo ucwords($entra);}else{ echo '-';}?></td-->
        </tr>
        <?php
				}
			?>
    </table>

		<!-- pagination block start -->
<?php echo print_paging($totalcount, $page, $perpage, $baseurl,'&page','','','','','');  ?>
<!-- pagination block end -->

		<!-- <div class="msg_lst">Your search returned: <span>59</span> matches</div>
		<div class="list_page2">  </div>
		<div class="inquiry2"><a href="#"><strong>wishlist</strong></a></div>
		<div class="wishlist"><a href="#"><strong>wishlist</strong></a></div> -->

<?php
	    }
	?> 
    </div>	
	
    <div class="clear"></div>
	<!-- << inner content>> -->
  </div>
  <!-- << content section -->
  <!-- footer section >> -->
<?php 
  require_once('includes/footer.php'); 
?>
